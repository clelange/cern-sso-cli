name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Install libfido2 (WebAuthn support)
      run: |
        sudo apt-get update
        sudo apt-get install -y libfido2-dev

    - name: Install dependencies
      run: go mod download

    - name: Check CERN CA certificates are up to date
      run: make check-certs

    - name: Download CERN CA certificates
      run: make download-certs

    - name: Run Unit Tests
      run: make test

    - name: Verify Build
      run: make build

    - name: Verify Cross-Platform Builds
      run: make build-all

  # Integration tests using credential cache (kinit)
  integration-ccache:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      KRB5_USERNAME: ${{ secrets.KRB5_USERNAME }}
      KRB5_PASSWORD: ${{ secrets.KRB5_PASSWORD }}
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Download CERN CA certificates
      run: make download-certs

    - name: Install Kerberos and libfido2
      run: |
        sudo apt-get update
        sudo apt-get install -y krb5-user libfido2-dev

    - name: Configure Kerberos
      run: |
        sudo tee /etc/krb5.conf << 'EOF'
        [libdefaults]
            default_realm = CERN.CH
            dns_lookup_realm = false
            dns_lookup_kdc = true
            rdns = false
            ticket_lifetime = 24h
            forwardable = true
            udp_preference_limit = 0
            default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
            default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
            permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96

        [realms]
            CERN.CH = {
                kdc = cerndc.cern.ch
                default_domain = cern.ch
            }

        [domain_realm]
            .cern.ch = CERN.CH
            cern.ch = CERN.CH
        EOF

    - name: Get Kerberos ticket via kinit
      if: env.KRB5_USERNAME != '' && env.KRB5_PASSWORD != ''
      run: |
        echo "$KRB5_PASSWORD" | kinit "${KRB5_USERNAME}@CERN.CH"
        klist

    - name: Build
      run: make build

    - name: Test with credential cache (no password env vars)
      if: env.KRB5_USERNAME != '' && env.KRB5_PASSWORD != ''
      run: |
        # Unset password env vars to ensure we use ccache
        unset KRB5_USERNAME KRB5_PASSWORD

        # Test cookie command with ccache
        ./cern-sso-cli cookie --url https://gitlab.cern.ch --file test_cookies.txt

        # Verify cookies were created
        if [ ! -f test_cookies.txt ]; then
          echo "ERROR: Cookie file not created"
          exit 1
        fi

        echo "SUCCESS: Credential cache authentication works!"
        cat test_cookies.txt

  # Integration tests using password (fallback method)
  integration-password:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      KRB5_USERNAME: ${{ secrets.KRB5_USERNAME }}
      KRB5_PASSWORD: ${{ secrets.KRB5_PASSWORD }}
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Install libfido2 (WebAuthn support)
      run: |
        sudo apt-get update
        sudo apt-get install -y libfido2-dev

    - name: Install dependencies
      run: go mod download

    - name: Download CERN CA certificates
      run: make download-certs

    - name: Run Integration Tests
      if: env.KRB5_USERNAME != '' && env.KRB5_PASSWORD != ''
      run: make test-integration

  # Integration tests using keytab (from cern-get-keytab)
  integration-keytab:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      KRB5_KEYTAB: ${{ secrets.KRB5_KEYTAB }}
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Install Kerberos and libfido2
      run: |
        sudo apt-get update
        sudo apt-get install -y krb5-user libfido2-dev

    - name: Configure Kerberos
      run: |
        sudo tee /etc/krb5.conf << 'EOF'
        [libdefaults]
            default_realm = CERN.CH
            dns_lookup_kdc = true
        [realms]
            CERN.CH = { kdc = cerndc.cern.ch }
        [domain_realm]
            .cern.ch = CERN.CH
        EOF

    - name: Download CERN CA certificates
      run: make download-certs

    - name: Build
      run: make build

    - name: Decode keytab from secret
      if: env.KRB5_KEYTAB != ''
      run: |
        echo "${KRB5_KEYTAB}" | base64 -d > /tmp/test.keytab
        chmod 600 /tmp/test.keytab
        echo "=== Keytab contents ==="
        klist -kt /tmp/test.keytab

    - name: Test --keytab flag
      if: env.KRB5_KEYTAB != ''
      run: |
        ./cern-sso-cli cookie --url https://gitlab.cern.ch --keytab /tmp/test.keytab --file test_cookies.txt
        if [ ! -f test_cookies.txt ]; then
          echo "ERROR: Cookie file not created with --keytab"
          exit 1
        fi
        echo "SUCCESS: --keytab authentication works!"
        cat test_cookies.txt

    - name: Test --use-keytab with KRB5_KTNAME
      if: env.KRB5_KEYTAB != ''
      env:
        KRB5_KTNAME: /tmp/test.keytab
      run: |
        rm -f test_cookies.txt
        ./cern-sso-cli cookie --url https://gitlab.cern.ch --use-keytab --file test_cookies.txt
        if [ ! -f test_cookies.txt ]; then
          echo "ERROR: Cookie file not created with --use-keytab"
          exit 1
        fi
        echo "SUCCESS: --use-keytab with KRB5_KTNAME works!"

  # Unit tests on macOS
  test-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true
    - name: Install libfido2 (WebAuthn support)
      run: brew install libfido2
    - run: go mod download
    - run: make download-certs
    - run: make test
    - run: make build
    - run: make build-all

  # Integration tests on macOS with file-based cache
  # Note: API->file cache auto-conversion requires keychain setup which isn't available in CI
  integration-macos:
    runs-on: macos-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      KRB5_USERNAME: ${{ secrets.KRB5_USERNAME }}
      KRB5_PASSWORD: ${{ secrets.KRB5_PASSWORD }}
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache: true

    - name: Download CERN CA certificates
      run: make download-certs

    - name: Install libfido2 (WebAuthn support)
      run: brew install libfido2

    - name: Configure Kerberos
      run: |
        sudo tee /etc/krb5.conf << 'EOF'
        [libdefaults]

            default_realm = CERN.CH
            dns_lookup_realm = false
            dns_lookup_kdc = true
            rdns = false
            ticket_lifetime = 24h
            forwardable = true
            udp_preference_limit = 0
            default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
            default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
            permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96

        [realms]
            CERN.CH = {
                kdc = cerndc.cern.ch
                default_domain = cern.ch
            }

        [domain_realm]
            .cern.ch = CERN.CH
            cern.ch = CERN.CH
        EOF

    - name: Get Kerberos ticket (file-based cache for CI)
      if: env.KRB5_USERNAME != '' && env.KRB5_PASSWORD != ''
      run: |
        # Create file-based cache (keychain not available in CI)
        echo "$KRB5_PASSWORD" | kinit -c /tmp/krb5cc_ci "${KRB5_USERNAME}@CERN.CH"
        export KRB5CCNAME=/tmp/krb5cc_ci
        echo "=== Kerberos ticket (file-based cache) ==="
        klist

    - name: Build
      run: make build

    - name: Test with file-based cache
      if: env.KRB5_USERNAME != '' && env.KRB5_PASSWORD != ''
      env:
        KRB5CCNAME: /tmp/krb5cc_ci
      run: |
        # Unset password env vars to ensure we use ccache
        unset KRB5_USERNAME KRB5_PASSWORD

        # Run with file-based cache
        ./cern-sso-cli cookie --url https://gitlab.cern.ch --file test_cookies.txt

        # Verify cookies were created
        if [ ! -f test_cookies.txt ]; then
          echo "ERROR: Cookie file not created"
          exit 1
        fi

        echo "SUCCESS: macOS file-based cache works!"
        cat test_cookies.txt
